# 自动化股票数据获取程序实现方案

## 1. 需求分析
用户需要一个自动化程序，实现从获取A股所有股票代码到批量获取K线数据的完整流程，包括错误处理、日志记录和可配置性。

## 2. 现有代码分析
- 当前代码使用baostock库获取股票数据
- 已实现从文件读取股票代码功能
- 已实现单只股票K线数据获取
- 已实现数据保存到CSV和数据库
- 已实现基本日志系统

## 3. 实现方案

### 3.1 获取所有A股股票代码
- **功能**：从baostock获取所有A股股票代码和名称
- **实现**：新增`fetch_all_stock_codes`函数，使用`bs.query_all_stock`API
- **数据结构**：包含股票代码、股票名称、交易所等信息

### 3.2 结构化保存股票代码
- **功能**：将获取到的股票代码保存为结构化文件
- **实现**：新增`save_stock_codes`函数，支持CSV、JSON格式
- **文件名**：`stock_list.csv`或`stock_list.json`

### 3.3 批量获取K线数据
- **时间范围**：从2000年1月1日至程序执行当天
- **实现**：修改现有`fetch_stock_data`函数，支持配置开始日期
- **并发优化**：考虑使用多线程或异步请求提高效率

### 3.4 错误处理机制
- **网络重试**：添加请求失败重试逻辑，最多重试3次
- **备用方案**：当baostock不可用时，考虑其他数据源
- **异常处理**：跳过无效股票代码，记录错误信息

### 3.5 日志系统完善
- **进度记录**：记录数据获取进度，如"已处理100/1000只股票"
- **关键节点**：记录程序启动、结束时间，数据获取开始、结束时间
- **错误详情**：记录失败原因，便于调试

### 3.6 程序可配置性
- **配置文件**：创建`config.json`，包含以下配置项：
  - 数据源配置（baostock相关参数）
  - 数据获取配置（开始日期、结束日期、重试次数）
  - 并发配置（线程数、请求间隔）
  - 输出配置（文件格式、保存路径）
- **命令行参数**：支持通过命令行覆盖配置文件参数

## 4. 代码修改点

1. **新增函数**：
   - `fetch_all_stock_codes()`：获取所有A股股票代码
   - `save_stock_codes()`：保存股票代码到文件
   - `load_config()`：加载配置文件

2. **修改现有函数**：
   - `fetch_stock_data()`：添加重试逻辑，支持配置开始日期
   - `main()`：重构主函数，支持自动化流程

3. **新增配置文件**：`config.json`

## 5. 实现步骤

1. 实现配置文件加载功能
2. 实现获取所有A股股票代码功能
3. 实现股票代码保存功能
4. 修改K线数据获取函数，添加重试逻辑
5. 重构main函数，实现自动化流程
6. 测试程序功能
7. 优化并发处理

## 6. 预期效果

- 程序启动后自动获取所有A股股票代码
- 将股票代码保存为结构化文件
- 批量获取所有股票的K线数据，时间范围从2000年1月1日至今
- 实现完善的错误处理和日志记录
- 支持通过配置文件调整程序参数

## 7. 技术栈

- Python 3.x
- baostock库
- pandas
- SQLite
- 多线程/异步编程
- 日志模块

这个方案将使程序具备自动化、可配置性和健壮性，能够满足用户的需求。