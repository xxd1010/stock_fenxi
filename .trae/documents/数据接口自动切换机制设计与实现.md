# 数据接口自动切换机制设计与实现

## 1. 设计目标
实现baostock和akshare两个金融数据接口的无缝自动切换，确保数据获取的可靠性和稳定性。

## 2. 核心功能设计

### 2.1 接口状态管理
- 创建`DataSourceManager`类，负责管理两个接口的状态
- 维护接口状态信息：当前状态（正常/异常）、最后检测时间、连续失败次数、恢复时间等

### 2.2 实时可用性检测
- 实现`check_availability`方法，定期检测接口响应状态
- 检测内容包括：连接状态、数据返回质量、响应时间
- 支持配置检测频率

### 2.3 故障自动切换逻辑
- 当主接口出现异常时，在5秒内自动切换至备用接口
- 异常情况包括：连接超时、数据错误、返回空值、连续失败达到阈值
- 切换过程对上层业务逻辑透明

### 2.4 接口恢复自动切回
- 定期检测原故障接口的恢复情况
- 当接口恢复正常并稳定运行至少30秒后，自动切回原接口
- 支持配置恢复检测频率和稳定运行时间

### 2.5 完整的切换日志记录
- 记录每次切换的时间、原因、前后接口状态
- 记录接口检测结果和状态变化
- 支持配置日志级别和格式

### 2.6 配置化管理
- 在`config.json`中添加切换机制配置
- 支持配置：主接口优先级、检测频率、切换阈值、恢复条件等

## 3. 实现方案

### 3.1 修改配置文件
- 在`config.json`中添加`failover`配置项
- 配置示例：
  ```json
  "failover": {
    "enabled": true,
    "primary_source": "baostock",
    "secondary_source": "akshare",
    "check_interval": 60,
    "fail_threshold": 3,
    "recovery_delay": 30,
    "switch_timeout": 5
  }
  ```

### 3.2 创建数据源管理模块
- 新建`data_source_manager.py`文件
- 实现`DataSourceManager`类，包含以下核心方法：
  - `__init__`: 初始化状态管理器
  - `check_availability`: 检测接口可用性
  - `get_available_source`: 获取当前可用的数据源
  - `switch_source`: 切换数据源
  - `log_switch`: 记录切换日志

### 3.3 修改现有数据获取流程
- 修改`fetch_stock_data`和`fetch_all_stock_codes`函数
- 使用`DataSourceManager`获取当前可用的数据源
- 支持在单个请求中自动切换接口

### 3.4 实现检测线程
- 在主程序中启动一个后台线程，定期检测接口状态
- 支持动态调整检测频率
- 检测结果实时更新到状态管理器

## 4. 技术要点

### 4.1 线程安全设计
- 使用线程锁保护状态共享
- 确保切换过程的原子性

### 4.2 性能优化
- 检测过程异步执行，不影响主数据获取流程
- 合理设置检测频率，避免资源浪费

### 4.3 容错设计
- 检测过程本身的异常处理
- 避免误判和频繁切换

### 4.4 透明化设计
- 对上层业务逻辑保持透明
- 不需要修改现有调用方式

## 5. 实现步骤

1. 修改`config.json`，添加故障切换配置
2. 创建`data_source_manager.py`，实现数据源管理功能
3. 修改`stock_data_fetcher_v1.py`，集成自动切换机制
4. 测试切换机制的各项功能
5. 编写单元测试，验证切换逻辑的正确性

## 6. 预期效果

- 当主接口出现异常时，系统自动切换到备用接口，切换时间不超过5秒
- 当原接口恢复正常后，系统自动切回原接口
- 所有切换操作都有详细日志记录
- 支持通过配置文件灵活调整切换策略
- 对上层业务逻辑完全透明，不需要修改现有代码调用方式

## 7. 测试计划

- 模拟主接口故障，验证自动切换功能
- 模拟主接口恢复，验证自动切回功能
- 测试不同配置参数下的切换行为
- 测试并发情况下的切换稳定性
- 测试极端情况下的容错能力