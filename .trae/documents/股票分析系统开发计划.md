# 股票分析系统开发计划（更新版）

## 1. 系统架构设计

### 1.1 核心模块

| 模块名称 | 功能描述 | 实现方式 |
|---------|---------|---------|
| 数据读取模块 | 从数据库读取股票历史数据 | 使用现有的SQLiteDBManager类 |
| 技术指标计算模块 | 计算MACD、RSI、均线等技术指标 | 使用pandas_ta库 |
| 分析引擎模块 | 基于技术指标生成投资建议 | 传统分析+大模型分析（可选） |
| 抽样模块 | 测试阶段数据抽样 | 随机抽样+分层抽样 |
| 报告生成模块 | 生成详细分析报告 | Markdown格式报告 |
| 结果存储模块 | 存储分析结果 | SQLite数据库 |
| 对比评估模块 | 对比不同分析策略效果 | 回测+绩效指标计算 |

### 1.2 数据库设计

#### 1.2.1 现有表
- `history_k_data`：存储股票历史K线数据

#### 1.2.2 新增表
- `technical_indicators`：存储计算后的技术指标
- `analysis_results`：存储分析结果和投资建议
- `analysis_reports`：存储详细分析报告
- `strategy_performance`：存储不同策略的绩效评估

## 2. 详细设计

### 2.1 数据读取模块
- 使用现有的SQLiteDBManager类读取数据
- 支持按股票代码、日期范围查询
- 返回pandas DataFrame格式

### 2.2 技术指标计算模块
- 使用pandas_ta库计算技术指标
- 支持的指标：
  - 均线：MA5、MA10、MA20、MA60、MA120、MA250
  - MACD：快线、慢线、柱状图
  - RSI：RSI6、RSI12、RSI24
  - KDJ：K值、D值、J值
  - 布林带：上轨、中轨、下轨
  - 成交量指标：VOL5、VOL10、VOL20

### 2.3 分析引擎模块

#### 2.3.1 传统分析模式
- 基于技术指标的多因子模型
- 买入信号：
  - MACD金叉
  - RSI超卖区域（<30）
  - KDJ金叉
  - 价格突破布林带上轨
- 卖出信号：
  - MACD死叉
  - RSI超买区域（>70）
  - KDJ死叉
  - 价格跌破布林带下轨
- 持有信号：介于买入和卖出之间

#### 2.3.2 大模型分析模式
- 支持接入国内外主要大模型
- **国内大模型**：
  - 百度文心一言
  - 阿里巴巴通义千问
  - 腾讯混元
  - 字节跳动豆包
  - 华为盘古
  - 智谱清言
  - 商汤日日新
- **国外大模型**：
  - OpenAI GPT系列
  - Anthropic Claude系列
- 输入：股票历史数据、技术指标、市场环境
- 输出：投资建议、风险评估、预期收益
- 支持自定义prompt模板
- 支持多模型对比分析

### 2.4 抽样模块
- 随机抽样：从所有股票中随机选择一定比例
- 分层抽样：按行业、市值等维度分层抽样
- 支持配置抽样比例和最大样本数
- 测试模式下自动启用抽样

### 2.5 报告生成模块
- 生成单只股票的详细分析报告
- 包括：
  - 基本信息：股票代码、名称、行业
  - 技术指标分析：各指标的图表和解读
  - 投资建议：买入/持有/卖出评级
  - 决策依据：详细的分析逻辑
  - 风险提示：潜在风险因素
- 支持批量生成报告

### 2.6 结果存储模块
- 将分析结果存储到SQLite数据库
- 支持增量更新
- 支持按股票代码、日期、分析策略查询

### 2.7 对比评估模块
- 支持回测不同分析策略的历史表现
- 计算绩效指标：
  - 收益率
  - 最大回撤
  - 夏普比率
  - 胜率
  - 盈亏比
- 生成对比报告

## 3. 实现步骤

### 3.1 第一阶段：基础框架搭建
1. 创建项目目录结构
2. 实现技术指标计算模块
3. 实现数据读取模块
4. 创建数据库表结构

### 3.2 第二阶段：核心功能实现
1. 实现传统分析引擎
2. 实现抽样模块
3. 实现结果存储模块
4. 实现报告生成模块

### 3.3 第三阶段：高级功能实现
1. 实现大模型分析引擎（支持国内外主要大模型）
2. 实现对比评估模块
3. 优化性能和用户体验

### 3.4 第四阶段：测试和优化
1. 单元测试
2. 集成测试
3. 性能测试
4. 优化算法和代码

## 4. 技术栈

- 编程语言：Python
- 数据库：SQLite
- 数据处理：pandas、numpy
- 技术指标计算：pandas_ta
- 可视化：matplotlib、seaborn
- 大模型集成：
  - 国内：baidu-aip、dashscope（阿里云）、tencentcloud-sdk-python、doubao-sdk、pangu-sdk、zhipuai、sensecore-sdk
  - 国外：openai、anthropic
- 日志：loguru（现有）
- 配置管理：json（现有）

## 5. 配置设计

在现有config.json基础上新增分析相关配置：

```json
{
  "analysis": {
    "// 分析模式": "traditional=传统分析, llm=大模型分析, hybrid=混合分析",
    "mode": "traditional",
    "// 技术指标配置": "",
    "technical_indicators": {
      "// 均线周期": "",
      "ma_periods": [5, 10, 20, 60, 120, 250],
      "// MACD参数": "",
      "macd_params": [12, 26, 9],
      "// RSI周期": "",
      "rsi_periods": [6, 12, 24],
      "// KDJ参数": "",
      "kdj_params": [9, 3, 3],
      "// 布林带参数": "",
      "boll_params": [20, 2]
    },
    "// 大模型配置": "",
    "llm": {
      "// 模型提供商": "baidu=百度文心一言, alibaba=通义千问, tencent=腾讯混元, bytedance=豆包, huawei=华为盘古, zhipu=智谱清言, sensecore=商汤日日新, openai=OpenAI, anthropic=Anthropic",
      "provider": "baidu",
      "// 模型名称": "",
      "model_name": "ERNIE-Bot-4",
      "// API密钥配置": "",
      "api_keys": {
        "baidu": {
          "api_key": "your_baidu_api_key",
          "secret_key": "your_baidu_secret_key"
        },
        "alibaba": {
          "api_key": "your_alibaba_api_key"
        },
        "tencent": {
          "secret_id": "your_tencent_secret_id",
          "secret_key": "your_tencent_secret_key"
        },
        "bytedance": {
          "api_key": "your_bytedance_api_key"
        },
        "huawei": {
          "api_key": "your_huawei_api_key",
          "endpoint": "your_huawei_endpoint"
        },
        "zhipu": {
          "api_key": "your_zhipu_api_key"
        },
        "sensecore": {
          "api_key": "your_sensecore_api_key"
        },
        "openai": {
          "api_key": "your_openai_api_key"
        },
        "anthropic": {
          "api_key": "your_anthropic_api_key"
        }
      },
      "// 温度参数": "",
      "temperature": 0.1,
      "// 最大 tokens": "",
      "max_tokens": 1000,
      "// 多模型对比": "是否启用多模型对比分析",
      "multi_model_comparison": false,
      "// 对比模型列表": "",
      "comparison_models": ["ERNIE-Bot-4", "qwen-turbo", "gpt-4"]
    },
    "// 抽样配置": "",
    "sampling": {
      "// 抽样模式": "random=随机抽样, stratified=分层抽样",
      "mode": "random",
      "// 抽样比例": "",
      "ratio": 0.1,
      "// 最大样本数": "",
      "max_samples": 100
    },
    "// 报告配置": "",
    "report": {
      "// 报告格式": "markdown=Markdown, html=HTML",
      "format": "markdown",
      "// 报告保存路径": "",
      "save_path": "reports/",
      "// 是否生成图表": "",
      "generate_charts": true
    }
  }
}
```

## 6. 预期输出

### 6.1 分析结果表（analysis_results）

| 字段名 | 类型 | 描述 |
|-------|------|------|
| id | INTEGER | 主键ID |
| stock_code | TEXT | 股票代码 |
| analysis_date | TEXT | 分析日期 |
| strategy | TEXT | 分析策略 |
| rating | TEXT | 投资评级（买入/持有/卖出） |
| score | REAL | 评分（0-100） |
| macd_signal | TEXT | MACD信号 |
| rsi_signal | TEXT | RSI信号 |
| kdj_signal | TEXT | KDJ信号 |
| boll_signal | TEXT | 布林带信号 |
| ma_signal | TEXT | 均线信号 |
| llm_analysis | TEXT | 大模型分析结果（可选） |
| llm_provider | TEXT | 大模型提供商 |
| llm_model | TEXT | 大模型名称 |
| risk_level | TEXT | 风险等级 |
| expected_return | REAL | 预期收益率 |
| created_at | TEXT | 创建时间 |

### 6.2 分析报告示例

```markdown
# 股票分析报告

## 基本信息
- 股票代码：sh.600000
- 股票名称：浦发银行
- 分析日期：2023-10-01
- 分析策略：混合分析（传统+大模型）
- 大模型：百度文心一言（ERNIE-Bot-4）

## 技术指标分析

### 均线分析
- MA5：10.25
- MA10：10.30
- MA20：10.45
- 均线趋势：空头排列

### MACD分析
- DIF：-0.12
- DEA：-0.08
- MACD：-0.08
- 信号：死叉

### RSI分析
- RSI6：35.2
- RSI12：42.5
- RSI24：48.3
- 信号：中性

### KDJ分析
- K值：38.5
- D值：42.3
- J值：30.9
- 信号：金叉

## 投资建议
- 评级：持有
- 评分：55/100
- 决策依据：
  - MACD死叉，但RSI处于中性区域
  - KDJ金叉提供短期买入信号
  - 均线空头排列限制上涨空间
  - 大模型分析：综合考虑基本面和技术面，建议短期持有，等待均线系统修复
- 风险等级：中等
- 预期收益率：2-5%

## 大模型分析摘要

### 百度文心一言（ERNIE-Bot-4）

**分析结果**：
浦发银行当前处于震荡调整阶段，技术面呈现一定的矛盾信号。MACD死叉显示中期趋势偏弱，但KDJ金叉提供了短期反弹的可能。从基本面来看，银行板块估值处于历史低位，股息率较高，具有一定的安全边际。

**投资建议**：
短期建议持有，密切关注成交量变化和均线系统修复情况。如果股价能够站上MA20均线，可考虑适当加仓；如果跌破前期低点，应及时止损。

**风险提示**：
1. 宏观经济下行压力可能影响银行资产质量
2. 利率市场化进程可能压缩银行息差
3. 房地产行业风险可能传导至银行业

## 风险提示
- 宏观经济下行风险
- 银行业监管政策变化
- 不良贷款率上升风险
- 大模型分析存在不确定性
```

## 7. 测试策略

1. **单元测试**：对每个模块进行独立测试
2. **集成测试**：测试模块之间的交互
3. **回测**：使用历史数据测试分析策略的准确性
4. **性能测试**：测试系统在不同数据量下的性能
5. **A/B测试**：对比不同分析策略的效果
6. **多模型对比测试**：对比不同大模型的分析效果

## 8. 优化方向

1. **性能优化**：使用多线程或异步处理提高分析速度
2. **算法优化**：优化技术指标计算算法
3. **可扩展性**：支持更多数据源和技术指标
4. **可视化**：添加交互式可视化界面
5. **自动化**：支持定时自动分析和报告生成
6. **大模型优化**：优化prompt模板，提高大模型分析准确性

## 9. 风险控制

1. **数据质量**：确保输入数据的准确性和完整性
2. **模型风险**：对大模型输出进行验证和过滤
3. **性能风险**：设置合理的超时和重试机制
4. **安全风险**：保护API密钥和敏感数据
5. **合规风险**：确保分析报告符合相关法规要求
6. **依赖风险**：对外部API设置降级策略
7. **成本控制**：优化大模型调用频率，降低API成本
